## 1. 系统架构

系统采用前后端分离的架构模式，通过RESTful API进行通信。

### 1.1 架构图

```
+----------------------+    +-------------------------+    +------------------+
|                      |    |                         |    |                  |
|  前端 (Vue 3)        |<-->| 后端 API (Spring Boot) |<-->| 数据库 (KingBase)   |
|                      |    |                         |    |                  |
+----------------------+    +-------------------------+    +------------------+
                                      ^                           ^
                                      |                           |
                                      v                           v
                           +----------------------+    +------------------+
                           |                      |    |                  |
                           |  Redis (缓存)         |    | 阿里云OSS (存储)   |
                           |                      |    |                  |
                           +----------------------+    +------------------+
```

### 1.2 多租户架构

系统采用基于共享数据库、独立Schema的多租户架构：

- 每个租户（机构）拥有自己的数据隔离
- 用户通过租户标识访问专属环境
- 公共服务在所有租户间共享

## 2. 前端结构

前端项目位于`cemh-frontend`目录中，采用Vue 3框架构建。


### 2.1 主要页面

- **用户管理** (`UserManagement.vue`): 管理系统用户
- **部门管理** (`DeptManagement.vue`): 管理企业部门结构
- **租户管理** (`TenantManagement.vue`): 管理系统租户
- **会议管理** (`MeetingManagement.vue`): 管理会议安排
- **课程管理** (`CourseManagement.vue`): 管理课程信息
- **数据分析** (`Chat.vue`): 提供数据分析功能
- **新闻管理** (`NewsManagement.vue`): 管理新闻资讯

## 3. 后端结构

后端项目位于`cemh-backend`目录中，基于Spring Boot框架构建。

### 3.1 目录结构

```
cemh-backend/
├── src/main/
│   ├── java/com/cemh/
│   │   ├── common/      # 通用类和工具
│   │   ├── config/      # 配置类
│   │   ├── controller/  # 控制器
│   │   ├── dto/         # 数据传输对象
│   │   ├── entity/      # 实体类
│   │   ├── handler/     # 处理器
│   │   ├── mapper/      # MyBatis映射器
│   │   ├── service/     # 服务接口
│   │   │   └── impl/    # 服务实现
│   │   ├── utils/       # 工具类
│   │   └── vo/          # 视图对象
│   └── resources/
│       ├── mapper/      # MyBatis XML映射文件
│       ├── application.properties # 应用配置
│       └── application.yml       # YAML配置
└── pom.xml              # Maven配置文件
```

### 4.2 主要模块

- **用户管理**: 处理用户的CRUD操作和身份验证
- **部门管理**: 处理部门的CRUD和层级关系
- **租户管理**: 处理租户的CRUD和配置
- **会议管理**: 处理会议的预约、签到等
- **课程管理**: 处理课程的CRUD和学习记录
- **新闻管理**: 处理新闻资讯的发布和分类
- **文件上传**: 通过阿里云OSS处理文件存储

## 5. 数据库设计

### 5.1 主要表结构

#### sys_tenant（租户表）
- `id`: 主键
- `tenant_code`: 租户代码
- `tenant_name`: 租户名称
- `contact_name`: 联系人
- `contact_phone`: 联系电话
- `contact_email`: 联系邮箱
- `logo_url`: 企业Logo
- `domain`: 企业域名
- `status`: 状态（0-停用，1-正常，2-过期）
- `expire_time`: 过期时间
- `max_users`: 最大用户数
- `package_type`: 套餐类型
- `remark`: 备注
- `create_time`: 创建时间
- `update_time`: 更新时间
- `deleted`: 是否删除

#### sys_dept（部门表）
- `id`: 主键
- `tenant_id`: 租户ID
- `parent_id`: 父部门ID（指向租户ID或部门ID）
- `dept_code`: 部门编码
- `dept_name`: 部门名称
- `dept_type`: 部门类型
- `leader_id`: 负责人ID
- `phone`: 部门电话
- `email`: 部门邮箱
- `address`: 部门地址
- `sort_order`: 排序
- `status`: 状态（0-停用，1-正常）
- `remark`: 备注
- `create_time`: 创建时间
- `update_time`: 更新时间
- `deleted`: 是否删除

#### sys_user（用户表）
- `id`: 主键
- `tenant_id`: 租户ID
- `dept_id`: 部门ID
- `username`: 用户名
- `password`: 密码
- `real_name`: 真实姓名
- `email`: 邮箱
- `phone`: 电话
- `avatar`: 头像
- `status`: 状态（0-停用，1-正常）
- `create_time`: 创建时间
- `update_time`: 更新时间
- `deleted`: 是否删除

### 5.2 部门管理特殊设计

在部门管理中，`parent_id`字段有两种用途：
- 当`parent_id`等于`sys_tenant`表中的`id`时，表示该部门是公司的顶级部门
- 当`parent_id`等于其他部门`id`时，表示该部门是其他部门的子部门

这种设计允许系统灵活地表示组织架构，既可以表示部门与公司的从属关系，也可以表示部门间的层级关系。

## 6. 主要功能详解

### 6.1 多租户管理

- **租户创建与配置**: 支持创建新租户并进行基础配置
- **租户隔离**: 确保租户数据相互隔离
- **租户状态管理**: 支持启用、停用、过期等状态管理
- **续费管理**: 支持租户的续费操作

### 6.2 部门管理

#### 部门层级结构
系统支持复杂的部门层级结构：
- 公司为顶级组织
- 部门可以有多个子部门
- 支持无限层级嵌套

#### 部门操作
- **创建部门**: 可在公司下直接创建部门或在现有部门下创建子部门
- **编辑部门**: 修改部门信息，包括名称、编码、状态等
- **删除部门**: 删除部门（需先删除子部门）
- **部门查询**: 按名称、编码、状态等条件查询部门

### 6.3 用户管理

- 用户创建与管理
- 用户角色分配
- 用户部门分配
- 用户状态管理

### 6.4 会议管理

- 会议创建与安排
- 会议室预约
- 会议签到功能
- 会议资料管理

### 6.5 课程管理

- 课程创建与管理
- 课程资料上传
- 课程评价系统
- 学习进度跟踪

### 6.6 数据分析

- 数据可视化
- 交互式数据分析Chat
- 实时数据统计
- 自定义报表

### 6.7 文件存储

- 支持多种文件类型上传
- 使用阿里云OSS提供可靠存储
- 文件访问权限控制
- 按日期自动分类存储

## 7. API 文档

系统的API接口采用RESTful风格设计，并使用Knife4j进行文档化。访问路径：`http://服务器地址:8080/doc.html`

### 7.1 部门管理API

#### 获取企业下的部门列表
- **URL**: `/api/departments/by-tenant/{tenantId}`
- **方法**: GET
- **描述**: 根据租户ID获取该租户下的所有部门

#### 创建部门
- **URL**: `/api/departments`
- **方法**: POST
- **描述**: 创建新部门
- **请求体**: 部门信息对象

#### 更新部门
- **URL**: `/api/departments/{id}`
- **方法**: PUT
- **描述**: 更新指定部门信息
- **请求体**: 部门信息对象

#### 删除部门
- **URL**: `/api/departments/{id}`
- **方法**: DELETE
- **描述**: 删除指定部门

#### 获取部门详情
- **URL**: `/api/departments/{id}`
- **方法**: GET
- **描述**: 获取指定部门的详细信息

### 7.2 租户管理API

#### 获取租户列表
- **URL**: `/api/tenants/all`
- **方法**: GET
- **描述**: 获取所有租户信息

## 8. 关键实现细节

### 8.1 部门与租户关系处理

部门与租户关系的处理是系统的一个关键设计点，主要体现在以下方面：

#### 后端控制器(SysDeptController)处理:
- 创建部门时，如果parentId为空或0，会自动设置为租户ID
- 更新部门时，会验证parentId是否合法（要么是租户ID，要么是同一租户下的部门ID）
- 获取部门详情时，会根据parentId是否等于租户ID来设置parentName

#### XML映射文件(SysDeptMapper.xml)中的SQL查询:
- 使用左连接查询租户表和部门表
- 通过CASE语句判断parent_id是否等于租户ID，如果是则显示租户名称，否则显示上级部门名称

#### 前端实现(DeptManagement.vue):
- 组织架构树中显示公司和部门的层级关系
- 添加新部门时，parentId默认设置为当前公司的ID
- 修改部门时，保留原有的parentId值

### 8.2 树形结构构建

前端通过递归方式构建部门的树形结构:

1. 首先过滤出租户直属的顶级部门（parentId等于租户ID）
2. 然后对每个顶级部门，递归查找其子部门
3. 使用Element Plus的树形控件展示层级结构

### 8.3 类型转换处理

为确保ID比较的正确性，系统在关键位置进行了类型转换:

- 使用`parseInt()`确保ID进行数值比较而非字符串比较
- 在过滤和查找操作中统一采用数值比较

### 8.4 文件存储实现

系统通过整合阿里云OSS服务实现了可靠的文件存储功能:

- 文件按类型和日期自动分类存储
- 生成唯一的文件名避免冲突
- 返回可访问的URL供前端使用
