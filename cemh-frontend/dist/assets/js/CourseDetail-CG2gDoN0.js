import{_ as ce,a6 as de,a7 as ue,a8 as ve,a9 as fe,P as _e,aa as ge,ab as he,ac as me,ad as pe,c as m,g as ye,b as s,A as n,W as Ce,m as Ve,p as i,z as u,C as we,t as p,u as Ue,D as j,G as ke,a as f,r as Pe,o as Ie,M as Te,ae as Re,E as y,N as G,j as be,k as _,f as T,F as Le,d as Ne}from"./index-Ntw4s37F.js";import{c as A}from"./course-DBRud_bH.js";import{u as xe,l as H,g as De}from"./learning-C_xxH9mD.js";const Me={name:"CourseDetail",components:{Picture:pe,User:me,Clock:he,Star:ge,View:_e,VideoPlay:fe,Check:ve,VideoPause:ue,ArrowRight:de},setup(){const R=ke();be();const t=Ue(),V=j(()=>parseInt(R.params.id)),o=j(()=>t.userId||1),M=f(!1),E=f(!1),b=f(!1),w=f(!1),v=Pe({}),C=f([]),g=f(null),S=f([]),B=f("intro"),h=f(""),r=f(null),U=f([]),P=f(!1),L=f(0),F=f(0),k=f(null),O=j(()=>{if(!k.value||!C.value.length)return!1;const e=C.value.findIndex(a=>a.id===k.value.id);return e!==-1&&e<C.value.length-1});let N=null;const z=async()=>{M.value=!0;try{const e=await A.getCourseById(V.value);if(e.code===200){Object.assign(v,e.data),await A.incrementViewCount(V.value),await l(),await x(V.value),await q();const a=R.query.chapterId;if(a&&C.value.length>0){const c=C.value.find(d=>d.id==a);c&&setTimeout(()=>{W(c)},300)}}else y.error(e.message||"获取课程详情失败")}catch(e){console.error("获取课程详情失败:",e),y.error("获取课程详情失败")}finally{M.value=!1}},l=async()=>{try{const e=await A.getCourseChapters(V.value);e.code===200?C.value=e.data||[]:console.error("获取章节列表失败:",e.message)}catch(e){console.error("获取章节列表异常:",e)}},x=async e=>{try{const a=await De(o.value,e);a.code===200&&(g.value=a.data)}catch(a){console.error("获取学习记录失败:",a)}},q=async()=>{try{const e=await A.getLatestCourses(5);e.code===200&&(U.value=e.data.filter(a=>a.id!==v.id))}catch(e){console.error("获取相关课程失败:",e)}},J=async()=>{E.value=!0;try{v.videoUrl?(h.value=v.videoUrl,w.value=!0,g.value?g.value.status===0&&await H.saveOrUpdateRecord({...g.value,status:1}):await H.saveOrUpdateRecord({userId:o.value,courseId:V.value,progress:0,status:0}),await x(V.value)):y.warning("该课程暂无视频内容")}catch(e){console.error("开始学习失败:",e),y.error("开始学习失败")}finally{E.value=!1}},K=async()=>{b.value=!0;try{P.value=!P.value,y.success(P.value?"收藏成功":"取消收藏成功")}catch(e){console.error("收藏失败:",e),y.error("收藏失败")}finally{b.value=!1}},W=async e=>{try{w.value&&(w.value=!1,await G()),k.value=e,h.value=e.videoUrl,console.log("准备播放视频:",D(h.value)),setTimeout(()=>{w.value=!0,o.value&&H.saveOrUpdateRecord({userId:o.value,courseId:V.value,lastChapterId:e.id,progress:0,status:1}).then(()=>{x(V.value)})},100)}catch(a){console.error("播放视频失败:",a),y.error("播放视频失败: "+(a.message||"未知错误"))}},Q=e=>{switch(e){case 0:return"info";case 1:return"primary";case 2:return"success";case 3:return"warning";default:return"info"}},X=e=>{switch(e){case 0:return"未开始";case 1:return"学习中";case 2:return"已完成";case 3:return"已暂停";default:return"未知"}},Y=()=>{if(!r.value||!g.value)return;const e=r.value;if(!e.duration||isNaN(e.duration)||e.duration<=0)return;const a=Math.round(e.currentTime/e.duration*100);isNaN(a)||e.currentTime%10<.5&&I(a)},Z=()=>{I(100,2),y.success("恭喜您完成了本课程的学习！")},I=async(e,a)=>{try{if(!g.value)return;(isNaN(e)||e===null||e===void 0)&&(console.warn("无效的进度值:",e),e=0);const c=Math.max(0,Math.min(100,Math.round(e))),d=a||(c>0?1:0);await xe({userId:o.value,courseId:V.value,progress:c,status:d}),g.value&&(g.value.progress=c,g.value.status=d)}catch(c){console.error("更新学习进度失败:",c)}},$=e=>{if(!e)return"0分钟";const a=Math.floor(e/60),c=e%60;return a>0?`${a}小时${c}分钟`:`${c}分钟`},ee=e=>e<30?"#909399":e<70?"#e6a23c":"#67c23a",oe=e=>S.value.includes(e),ae=e=>{e.target.src="/default-course.png"},D=e=>{if(!e)return"";try{if(console.log("原始视频URL:",e),e=e.trim(),e.match(/^https?:\/\//))return console.log("视频URL已经是完整URL:",e),e;const a="http://localhost:8080";if(e.startsWith("/")||(e="/"+e),e.match(/\/uploads\/\d{8}_[a-f0-9-]+\.\w+$/)){const d=`${a}${e}`;return console.log("处理日期格式视频URL:",d),d}if(e.match(/\/uploads\/videos\/\d{4}\/\d{2}\/\d{2}\/[a-f0-9-]+\.\w+$/)){const d=`${a}${e}`;return console.log("处理目录结构视频URL:",d),d}if(!e.includes("/")||e===`/${e.split("/").pop()}`){const d=`${a}/uploads/${e.replace(/^\//,"")}`;return console.log("处理纯文件名:",d),d}if(e.startsWith("/uploads/")){const d=`${a}${e}`;return console.log("处理其他uploads格式URL:",d),d}const c=`${a}${e}`;return console.log("处理其他格式路径:",c),c}catch(a){return console.error("格式化视频URL时出错:",a),e}},te=()=>{if(console.log("视频对话框已打开"),h.value){const e=D(h.value);console.log("当前视频URL:",e)}G(()=>{if(r.value){console.log("视频元素已找到，准备播放"),r.value.onerror=function(e){console.error("视频加载出错:",e),y.error({message:"视频加载失败，请稍后再试",duration:3e3,showClose:!0}),setTimeout(()=>{try{console.log("尝试重新加载视频...");const a=D(h.value);r.value.src=a,r.value.load()}catch(a){console.error("重新加载视频失败:",a)}},1e3)};try{const e=D(h.value);r.value.src=e,r.value.load(),r.value.onloadedmetadata=function(){console.log("视频元数据已加载，时长:",r.value.duration);try{const a=r.value.play();a!==void 0&&a.then(()=>{console.log("视频开始播放")}).catch(c=>{console.log("视频自动播放失败，需要用户手动点击播放:",c),y.info("请点击播放按钮开始学习")})}catch(a){console.error("播放视频时出错:",a)}}}catch(e){console.error("加载视频时出错:",e)}}})},se=()=>{if(console.log("视频对话框已关闭"),r.value){const e=Math.round(r.value.currentTime/r.value.duration*100);I(e,3)}},re=()=>{if(console.log("视频已暂停"),r.value){const e=r.value.currentTime;console.log(`当前播放时间: ${e}秒`)}},ne=()=>{console.log("视频已开始/继续播放")},le=async()=>{if(r.value){r.value.pause();let e=0;r.value.duration&&!isNaN(r.value.duration)&&r.value.duration>0&&(e=Math.round(r.value.currentTime/r.value.duration*100),isNaN(e)&&(e=0)),await I(e,3),setTimeout(()=>{h.value="",w.value=!1,y.info("学习已暂停，进度已保存")},300)}else w.value=!1,y.info("学习已终止")},ie=()=>{if(!O.value)return;const e=C.value.findIndex(c=>c.id===k.value.id),a=C.value[e+1];a&&(r.value&&I(100,2),W(a))};return Ie(()=>{z(),N=setInterval(()=>{r.value&&!r.value.paused&&I()},3e4)}),Te(()=>{N&&clearInterval(N)}),Re(()=>{r.value&&r.value.pause()}),{loading:M,actionLoading:E,favoriteLoading:b,videoDialogVisible:w,course:v,chapters:C,learningRecord:g,activeTab:B,currentVideo:h,videoPlayer:r,relatedCourses:U,isFavorite:P,currentTime:L,duration:F,currentChapter:k,hasNextChapter:O,startLearning:J,addToFavorites:K,playChapter:W,getProgressColor:ee,formatDuration:$,isChapterCompleted:oe,getChapterStatusType:Q,getChapterStatusText:X,handleImageError:ae,formatVideoUrl:D,stopLearning:le,playNextChapter:ie,handleDialogOpen:te,handleDialogClose:se,handleVideoPause:re,handleVideoPlay:ne,handleVideoProgress:Y,handleVideoCompleted:Z}}},Ee={class:"course-detail"},Se={class:"course-header"},Oe={class:"course-cover"},Ae={key:1,class:"no-cover"},Be={class:"course-info"},Fe={class:"course-title"},ze={class:"course-meta"},We={class:"meta-item"},je={class:"meta-item"},He={class:"meta-item"},qe={class:"meta-item"},Ge={key:0,class:"course-price"},Je={class:"price"},Ke={key:1,class:"course-free"},Qe={class:"course-actions"},Xe={key:2,class:"learning-progress"},Ye={class:"progress-text"},Ze={class:"course-content"},$e={class:"course-description"},eo=["innerHTML"],oo={class:"course-chapters"},ao={key:0,class:"no-chapters"},to={key:1,class:"chapter-list"},so=["onClick"],ro={class:"chapter-number"},no={class:"chapter-info"},lo={class:"chapter-title"},io={class:"chapter-duration"},co={class:"chapter-status"},uo={class:"video-player-container"},vo=["src"],fo={key:1,class:"no-video"},_o={class:"video-controls"};function go(R,t,V,o,M,E){const b=u("el-image"),w=u("Picture"),v=u("el-icon"),C=u("User"),g=u("Clock"),S=u("Star"),B=u("View"),h=u("el-tag"),r=u("VideoPlay"),U=u("el-button"),P=u("el-progress"),L=u("el-tab-pane"),F=u("el-tabs"),k=u("VideoPause"),O=u("ArrowRight"),N=u("el-dialog"),z=Ce("loading");return _(),m("div",Ee,[ye((_(),m("div",Se,[s("div",Oe,[o.course.coverImage?(_(),Ve(b,{key:0,src:o.course.coverImage,fit:"cover",class:"cover-image",onError:o.handleImageError},null,8,["src","onError"])):(_(),m("div",Ae,[n(v,null,{default:i(()=>[n(w)]),_:1}),t[7]||(t[7]=s("span",null,"暂无封面",-1))]))]),s("div",Be,[s("h1",Fe,p(o.course.courseName),1),s("div",ze,[s("div",We,[n(v,null,{default:i(()=>[n(C)]),_:1}),s("span",null,"讲师："+p(o.course.instructor||o.course.courseAuthor),1)]),s("div",je,[n(v,null,{default:i(()=>[n(g)]),_:1}),s("span",null,"时长："+p(o.formatDuration(o.course.duration)),1)]),s("div",He,[n(v,null,{default:i(()=>[n(S)]),_:1}),s("span",null,"评分："+p(o.course.rating||0)+"分",1)]),s("div",qe,[n(v,null,{default:i(()=>[n(B)]),_:1}),s("span",null,"浏览："+p(o.course.viewCount||0)+"次",1)])]),o.course.isFree?(_(),m("div",Ke,[n(h,{type:"success"},{default:i(()=>t[8]||(t[8]=[T("免费课程")])),_:1,__:[8]})])):(_(),m("div",Ge,[s("span",Je,"¥"+p(o.course.price),1)])),s("div",Qe,[n(U,{type:"primary",size:"large",onClick:o.startLearning,loading:o.actionLoading},{default:i(()=>[n(v,null,{default:i(()=>[n(r)]),_:1}),T(" "+p(o.learningRecord?"继续学习":"开始学习"),1)]),_:1},8,["onClick","loading"]),n(U,{size:"large",onClick:o.addToFavorites,loading:o.favoriteLoading},{default:i(()=>[n(v,null,{default:i(()=>[n(S)]),_:1}),t[9]||(t[9]=T(" 收藏课程 "))]),_:1,__:[9]},8,["onClick","loading"])]),o.learningRecord?(_(),m("div",Xe,[s("div",Ye," 学习进度："+p(o.learningRecord.progress)+"% ",1),n(P,{percentage:o.learningRecord.progress,color:o.getProgressColor(o.learningRecord.progress)},null,8,["percentage","color"])])):we("",!0)])])),[[z,o.loading]]),s("div",Ze,[n(F,{modelValue:o.activeTab,"onUpdate:modelValue":t[0]||(t[0]=l=>o.activeTab=l),type:"card"},{default:i(()=>[n(L,{label:"课程介绍",name:"intro"},{default:i(()=>[s("div",$e,[t[10]||(t[10]=s("h3",null,"课程简介",-1)),s("div",{class:"description-content",innerHTML:o.course.description||o.course.courseIntro||"暂无课程介绍"},null,8,eo)])]),_:1}),n(L,{label:"课程目录",name:"chapters"},{default:i(()=>[s("div",oo,[t[11]||(t[11]=s("h3",null,"课程目录",-1)),o.chapters.length===0?(_(),m("div",ao," 暂无课程章节 ")):(_(),m("div",to,[(_(!0),m(Le,null,Ne(o.chapters,(l,x)=>(_(),m("div",{key:l.id,class:"chapter-item",onClick:q=>o.playChapter(l)},[s("div",ro,p(x+1),1),s("div",no,[s("div",lo,p(l.chapterName||l.title),1),s("div",io,p(o.formatDuration(l.duration)),1)]),s("div",co,[n(h,{type:o.getChapterStatusType(l.status),size:"small"},{default:i(()=>[T(p(o.getChapterStatusText(l.status)),1)]),_:2},1032,["type"])])],8,so))),128))]))])]),_:1}),n(L,{label:"评价反馈",name:"reviews"},{default:i(()=>t[12]||(t[12]=[s("div",{class:"course-reviews"},[s("h3",null,"学员评价"),s("div",{class:"no-reviews"}," 暂无评价内容 ")],-1)])),_:1,__:[12]})]),_:1},8,["modelValue"])]),n(N,{title:o.currentChapter?o.currentChapter.chapterName:"视频学习",modelValue:o.videoDialogVisible,"onUpdate:modelValue":t[6]||(t[6]=l=>o.videoDialogVisible=l),fullscreen:"","destroy-on-close":"","append-to-body":!0,onOpen:o.handleDialogOpen,onClose:o.handleDialogClose},{default:i(()=>[s("div",uo,[o.currentVideo?(_(),m("video",{key:0,ref:"videoPlayer",controls:"",class:"video-player",onTimeupdate:t[1]||(t[1]=(...l)=>o.handleVideoProgress&&o.handleVideoProgress(...l)),onEnded:t[2]||(t[2]=(...l)=>o.handleVideoCompleted&&o.handleVideoCompleted(...l)),onPause:t[3]||(t[3]=(...l)=>o.handleVideoPause&&o.handleVideoPause(...l)),onPlay:t[4]||(t[4]=(...l)=>o.handleVideoPlay&&o.handleVideoPlay(...l)),onError:t[5]||(t[5]=(...l)=>R.handleVideoError&&R.handleVideoError(...l)),src:o.formatVideoUrl(o.currentVideo)}," 您的浏览器不支持视频播放。 ",40,vo)):(_(),m("div",fo," 暂无视频内容 ")),s("div",_o,[n(U,{type:"primary",onClick:o.stopLearning},{default:i(()=>[n(v,null,{default:i(()=>[n(k)]),_:1}),t[13]||(t[13]=T(" 终止学习 "))]),_:1,__:[13]},8,["onClick"]),n(U,{type:"success",onClick:o.playNextChapter,disabled:!o.hasNextChapter},{default:i(()=>[n(v,null,{default:i(()=>[n(O)]),_:1}),t[14]||(t[14]=T(" 下一章节 "))]),_:1,__:[14]},8,["onClick","disabled"])])])]),_:1},8,["title","modelValue","onOpen","onClose"])])}const yo=ce(Me,[["render",go],["__scopeId","data-v-774a2c6e"]]);export{yo as default};
